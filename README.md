# SDrecall

## Note: BIG UPDATE on the branch rust-impl. Dramatic speed-up with phasing graph building migrated to Rust extension. Also significant improvement on misalignment filtration after realignment. Please redirect to the rust-impl branch for updated performance. 

## Key Notes before implementing SDrecall to your pipeline
1. SDrecall is the first tool offer sensitive and scalable variant detection within SDs based on NGS data alone. 

2. SDrecall is primarily designed for molecular diagnosis of Mendelian diseases where the causal variants are mostly rare and deleterious. Thus pursuing sensitivity over precision.

3. Despite the relatively low precision rate, SDrecall's rigorous FP control managed to mitigate the amount of rare and deleterious FPs introduced by SDrecall. So that the expert review of molecular diagnosis will only be noised by minimal FPs from SDrecall (around 1-2 rare and deleterious FPs across the whole exome according to our test on GIAB data).

4. SDrecall serve as a free add-on instead of a replacement to conventional variant callers (GATK, DeepVariant, etc.). Callsets generated by SDrecall should be merged into the callset generated by your own callers for downstream analysis.

5. It is recommended to run SDrecall on dozens of control samples with the similar coverage profile. Then merge them with bcftools and have AC and AN INFO tags calculated in the final merged VCF. This way, the AN, AC info for each variant called by SDrecall within your inhouse control cohort can be exploited to estimate whether it is truly a common variant in the general population. This is important because traditional population databases like gnomAD and 1000g is based on NGS data, therefore having gaps on the regions like segmental duplications due to the mapping ambiguity.

6. The targeting regions is important to the output and efficiency of SDrecall. We recommend targeting the known causal genes/regions for the patients with relevant phenotypes. If phenotype diagnosis is vague to indicate a range of causal genes, then targeting Challenging Medical Relevant Genes from Genome In A Bottle is a cost-effective strategy. 


For molecular diagnosis of Mendelian disease patients, SDrecall provides comprehensive inspection of SD regions that would otherwise be missed by traditional NGS analysis pipelines, while introducing marginal noise that could interfere with causal variant identification downstream. Please cite the following paper if you use SDrecall in your research: https://www.researchgate.net/publication/386155530_SDrecall_A_Scalable_Approach_for_Sensitive_Variant_Detection_in_Segmental_Duplications (under review)

## Installation

### Using conda/mamba
Users should first clone this repository to a local directory.

For mamba/conda users, create an environment from YAML:
```bash
mamba env create -f ./SDrecall.yml --channel-priority flexible
mamba activate SDrecall
```

### Using docker/singularity
Given the long list of dependencies of SDrecall, we are still working on a docker file / singularity recipe. Any contributions are most welcome.

## Overview of the workflow 

Define regions need variant rescuing:
1. Locate regions suffering multi-alignments from the input BAM file (DP >= 3 regardless of MAPQ) & (DP < 10 when MAPQ >= 41)
2. Locate SDs overlapping with multi-aligned regions. Establish a multiplex SD network to help extract their homologous counterparts.

Realignment and variant calling:
1. Recruiting reads from the homologous counterparts and perform realignment. 
2. Perform graph-based phasing to group realigned reads into distinct haplotypes.
3. Eliminate less optimal haplotypes from the realignments with Binary Integer Constraint Programming.
4. Variant calling with BCFtools based on the filtered realignments.

Post-processing:
1. Merging the result variants with conventional caller variants (Suggested follow up process)
2. Annotating common variants using a cohort VCF (optional but suggested)


## Usage
SDrecall provides three main execution modes:


### Inputs

- **BAM file**: Aligned sequencing reads (must be sorted by coordinates and indexed)
- **Reference genome**: FASTA format (hg19 or hg38 supported)
- **Reference SD map**: BED file with segmental duplication coordinates (Two gzipped bed files are offered in data/hg19(hg38)/ref_SD)
- **Target BED** : Specific regions to analyze (the targeting regions you want to ensure detection sensitivity. For molecular diagnosis of Mendelian diseases, this can be the whole exome, or the coding regions of functionally relevant genes.)
- **Supplementary VCF** (optional but recommended): Conventional caller results to merge with (The VCF file of the same sample, called by other conventional callers like GATK and DeepVariant. If provided, SDrecall will try to merge its own output with this VCF file to offer a final output VCF for downstream analysis)
- **Cohort VCF** (optional but recommended): Population data for identifying common variants ( It is recommended to perform SDrecall on dozens of control samples with the similar coverage profile. Then merge them with bcftools and have AC and AN INFO tags calculated in the final merged VCF. This way, the AN, AC info for each variant called by SDrecall within your inhouse control cohort can be exploited to estimate whether it is truly a common variant in the general population. This is important because traditional population databases like gnomAD and 1000g is based on NGS data, therefore having gaps on the regions like segmental duplications due to the mapping ambiguity)

### Outputs

The main outputs include:
- **Filtered BAM files**: Realigned reads in SD regions (in `<output_dir>/<sample_id>_<assembly>_<target_tag>_SDrecall/recall_results`)
- **Variant calls**: VCF files with variants in SD regions (in `<output_dir>/<sample_id>_<assembly>_<target_tag>_SDrecall/recall_results/<sample_id>.sdrecall.vcf.gz`)
- **Final merged VCF**: Combined results with appropriate filters/tags (in `<output_dir>/final_vcf/`)
- **Log files**: Detailed processing information

### Advanced Features

- **Mapping quality filtering**: Adjust thresholds with `--mq_cutoff` (default: 41)
- **Depth filtering**: Control with `--high_quality_depth` (default: 10, used for pickup multialigned regions, specifies maximal depth of high MAPQ reads to be considered as insufficient coverage for downstream variant calling) and `--minimum_depth` (default: 3, used for pick up the region suffering multialignments, this specifies the minimal required depth regardless of MAPQs)
- **Confidence levels**: Set statistical confidence with `--conf_level` (default: 0.999, used for common variant estimation)
- **Variant filtering**: Filter with `--inhouse_common_cutoff` (default: 0.01) when using cohort data
- **Performance tuning**: Adjust `--threads` for overall parallelism and `--numba_threads` for computational acceleration

### Complete Pipeline
### With Supplementary VCF and Cohort Annotation (Recommended way to run SDrecall)

```bash
# Run with conventional caller integration and cohort annotation
SDrecall run \
  -i input.bam \
  -r /path/to/reference.fa \
  -m /path/to/sd_map.bed \
  -b /path/to/target.bed \
  -o /path/to/output_dir \
  -t 16 \
  -s <sample_id> \
  --target_tag <label_of_target_region> \
  --conventional_vcf /path/to/deep_variant.vcf \
  --caller_name DeepVariant \
  --cohort_vcf /path/to/control_cohort.vcf \
  --inhouse_common_cutoff 0.01 \
  --cohort_conf_level 0.99
```

### Without Supplementary VCF and Cohort Annotation

```bash
# Run the complete SDrecall pipeline
SDrecall run \
  -i input.bam \
  -r /path/to/reference.fa \
  -m /path/to/sd_map.bed \
  -o /path/to/output_dir \
  -b /path/to/target.bed \
  -t 16 \
  -s <sample_id> \
  --target_tag <label_of_target_region> \
```

### Preparation Only

```bash
# Run only the preparation phase (identifies SD regions, creates masked references)
SDrecall prepare \
  -i input.bam \
  -r /path/to/reference.fa \
  -m /path/to/sd_map.bed \
  -o /path/to/output_dir \
  -b /path/to/target.bed \
  -t 16 \
  -s <sample_id> \
  --target_tag <label_of_target_region> \
  --high_quality_depth 10 \
  --minimum_depth 3
```

### Realignment and Recall Only

```bash
# Run only realignment and recall (requires preparation output)
SDrecall realign \
  -i input.bam \
  -r /path/to/reference.fa \
  -m /path/to/sd_map.bed \
  -b /path/to/target.bed \
  -o /path/to/output_dir \
  -s <sample_id> \
  -t 16 \
  --target_tag <label_of_target_region> \
  --numba_threads 4
```

### Common Arguments Use SDrecall --help and SDrecall run/prepare/realign --help to see the full argument list

```
-i, --input_bam        Input BAM file path (must be indexed)
-r, --ref_genome       Reference genome path
-m, --reference_sd_map Reference segmental duplication map
-o, --outdir           Output directory
-b, --target_bed       Required target regions for analysis (default: whole exome, offered in data/hg19(38)/default_target)
-s, --sample_id        Sample ID (default: extracted from BAM filename)
-t, --threads          Number of threads to use (default: 10)
-v, --verbose          Verbosity level (INFO, DEBUG, etc.)
--target_tag           Label of the target region (recommended to specify)
```

### Example -- Targeting Challenging Medical Relevant Genes from Genome In A Bottle
Inside the example folder, we offered a small example for user to test the installation, which require around 15min to finish when executed with 10 threads.

In order to run the example, users need to offer ucsc.hg38.fasta file and specify an output folder in their local host file system. Then just run the shell script with the command below:

```bash
# Run only realignment and recall (requires preparation output)
bash ./example/example_run.sh \
  -o <output_folder> \
  -r /path/to/ucsc.hg38.fasta \
  -t <threads>
```

This example is targeting Challenging Medical Relevant Genes from Genome In A Bottle on hg38 assembly. In routine analysis, if you do not have a specific range of genes suspected for causality, you can also use this region set as default cause it already contains all the genes known for mappability issue and association with Mendelian diseases. Which saves computation burdens in comparison to targeting the whole exome or whole genome. 

## Code development and feature requests
SDrecall is now ready for production. We welcome all kinds of suggestions and collaborations.

## Contact and correspondence
Xingtian Yang (yangyxt@hku.hk), Louis She (snakesch@connect.hku.hk)

